
<%- include("../layouts/user/header.ejs") %>
<style>
    .cart-summary-table th,
    .cart-summary-table td {
        padding: 10px;
        border-top: 1px solid #ddd;
    }
    
    .cart-summary-table th {
        text-align: left;
        background-color: #f2f2f2;
    }
    
    
    .cart-summary-table tr:nth-child(n+2) td {
        border-top: 2px solid #ddd;
    }
    
    
    .cart-summary-table tr:nth-child(n+2) td {
        font-weight: bold;
        color: #333;
    }
    </style>

<!-- Start Header -->
<header
    class="header-area haeder-default header--transparent black-logo-version ptb_lg--40 ptb_md--40 ptb_sm--30">
    <div class="header-wrapper container">
        <div class="row align-items-center">
            <!-- Start Header Left -->
            <div class="col-xl-2 col-lg-6 col-md-6 col-sm-6 col-6">
                <div class="logo">
                    <a href="/">
                        <img src="assets/images/logo/logo-black.png"
                            alt="Draven logo">
                    </a>
                </div>
            </div>
            <!-- Start Header Center -->
            <div class="col-xl-9 d-none d-xl-block">
                <nav class="mainmenu__nav">
                    <!-- Start Mainmanu Nav -->
                    <ul class="primary-menu megamenu-wrapper">
                        <li><a href="/">Home</a>
                        </li>
                        <li><a href="/about">About</a></li>
                        <li class="lavel-1"><a href="/shop">Shop</a>
                            <ul class="dropdown__menu">
                                <li><a href="/shop"><span>Shop</span></a></li>
                                <li><a href="/shop-left-sidebar"><span>Shop Left
                                            Sidebar</span></a></li>
                                <li><a href="/shop-right-sidebar"><span>Shop No
                                            Sidebar</span></a></li>
                                <li><a href="/product-details"><span>Product
                                            Details</span></a></li>
                            </ul>
                        </li>
                        <li><a href="/blog">Blog</a>
                            <!-- <ul class="dropdown__menu">
                                    <li><a href="blog.html"><span>Blog</span></a></li>
                                    <li><a href="blog-left-sidebar.html"><span>Blog Left Sidebar</span></a></li>
                                    <li><a href="blog-details.html"><span>Blog Details</span></a></li>
                                </ul> -->
                        </li>
                        <li class="lavel-1"><a href="#">Pages</a>
                            <ul class="dropdown__menu">
                                <li><a href="/cart"><span>Cart</span></a></li>
                                <li><a
                                        href="/checkout"><span>Checkout</span></a></li>
                                <li><a
                                        href="/wishlist"><span>Wishlist</span></a></li>
                                <li><a
                                        href="/compare"><span>Compare</span></a></li>
                                <li><a href="/my-account"><span>My
                                            Account</span></a></li>
                                <li><a href="/login"><span>Login</span></a></li>
                                <li><a href="/sign-up"><span>sign
                                            Up</span></a></li>
                            </ul>
                        </li>
                        <li><a href="/contact">Contact</a></li>

                    </ul>
                    <!-- End Mainmanu Nav -->
                </nav>
            </div>
            <!-- Start Header Right -->
            <div class="col-xl-1 col-lg-6 col-md-6 col-sm-6 col-6">
                <div
                    class="header-icon d-flex justify-content-end cart text-right">
                    <a class="cart-trigger" href="#">
                        <i class="fa fa-shopping-cart"></i>
                        <span class="cart-count">03</span>
                    </a>
                    <a class="hamburger-trigger d-block d-xl-none pl--15"
                        href="#">
                        <i class="fa fa-bars"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>
<!-- Start Search Flyover -->
<div class="search-flyoveray"></div>
<div class="cart-flyout">
    <div class="cart-flyout-inner">
        <a class="btn-close-cart" href="#">
            <i class="fa fa-times"></i>
        </a>
        <div class="cart-flyout__content">
            <div class="cart-flyout__heading">Shopping Cart</div>
            <div class="widget_shopping_cart_content">
                <ul class="product_list_widget">
                    <li>
                        <div class="thumb">
                            <img src="assets/images/product/sm-product-01.jpg"
                                alt="product">
                        </div>
                        <div class="content">
                            <h6><a href="/single-product">Boys light blue
                                    jacket</a></h6>
                            <div class="quntity">1 × $35.99</div>
                            <button class="remove-btn">×</button>
                        </div>
                    </li>

                    <li>
                        <div class="thumb">
                            <img src="assets/images/product/sm-product-02.jpg"
                                alt="product">
                        </div>
                        <div class="content">
                            <h6><a href="/single-product">Boys light blue
                                    jacket</a></h6>
                            <div class="quntity">1 × $35.99</div>
                            <button class="remove-btn">×</button>
                        </div>
                    </li>

                    <li>
                        <div class="thumb">
                            <img src="assets/images/product/sm-product-03.jpg"
                                alt="product">
                        </div>
                        <div class="content">
                            <h6><a href="/single-product">Boys light blue
                                    jacket</a></h6>
                            <div class="quntity">1 × $35.99</div>
                            <button class="remove-btn">×</button>
                        </div>
                    </li>

                </ul>
            </div>
            <p class="minicart__total">Subtotal: <span
                    class="price">164.97</span></p>
            <div class="cart__btn">
                <a href="/cart">View cart</a>
                <a href="/checkout">Checkout</a>
            </div>
        </div>
    </div>
</div>

<!--end search flyover-->
<!-- Start Hamburger -->
<div class="hamburger-area">
    <div class="btn-close-search">
        <button>
            <i class="fa fa-times" aria-hidden="true"></i>
        </button>
    </div>
    <!-- Start Main Menu -->
    <ul class="menu-primary-menu-1 responsive-manu d-block d-xl-none"
        id="responsive-manu">
        <li><a href="/">Home</a> </li>
        <li><a href="about.html">About</a></li>
        <li class="has-dropdown"><a href="/shop">Shop</a>
            <ul class="sub-menu">
                <li><a href="/shop"><span>Shop</span></a></li>
                <li><a href="/shop-left-sidebar"><span>Shop Left
                            Sidebar</span></a></li>
                <li><a href="/shop-right-sidebar"><span>Shop No
                            Sidebar</span></a></li>
                <li><a href="/product-details"><span>Product
                            Details</span></a></li>
            </ul>
        </li>
        <li class="has-dropdown"><a href="#">Pages</a>
            <ul class="sub-menu">
                <li><a href="/cart"><span>Cart</span></a></li>
                <li><a href="/checkout"><span>Checkout</span></a></li>
                <li><a href="/wishlist"><span>Wishlist</span></a></li>
                <li><a href="/compare"><span>Compare</span></a></li>
                <li><a href="/profile"><span>profile</span></a></li>
                <li><a href="/login"><span>Login</span></a></li>
                <li><a href="/sign-up"><span>sign Up</span></a></li>
            </ul>
        </li>
        <li class="has-dropdown"><a href="/blog">Blog</a>
            <ul class="sub-menu">
                <li><a href="/blog"><span>Blog</span></a></li>
                <li><a href="/blog-left-sidebar"><span>Blog Left
                            Sidebar</span></a></li>
                <li><a href="/blog-details"><span>Blog Details</span></a></li>
            </ul>
        </li>
        <li><a href="/contact">Contact</a></li>
    </ul>
    <!-- End Main Menu -->
</div>
<!-- End Hamburger -->

<!-- Start Breadumb Area -->
<div
    class="breadcumb-area ptb--100 ptb_md--100 ptb_sm--100  bg_image bg_image--3">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="inner text-center">
                    <h2 class="font--40 mb--0">Cart</h2>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Breadumb Area -->
<div class="main-wrapper">

    <!-- Cart Page Start -->
    <div class="cart_area pt--120 pb--80 bg-color pt_md--80 pt_sm--80"
        data-bg-color="#ffffff">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <form>
                        <!-- Cart Table -->
                        <div class="cart-table table-responsive mb--40">
                            <table class="table">
                                <thead>

                                    <tr>
                                        <th class="pro-thumbnail">Image</th>
                                        <th class="pro-title">Product</th>
                                        <th class="pro-price">Price</th>
                                        <th class="pro-quantity">Quantity</th>
                                        <th class="pro-subtotal">Total</th>
                                        <th class="pro-remove">Remove</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if(cart && cart.length > 0) { %>
                                        <% cart.forEach(cartItem => { %>
                                            <% cartItem.products.forEach(product => { %>
                                                <% if (product && product.productId) { %> <!-- Safeguard to check if product and productId exist -->
                                                    <tr>
                                                        <td class="pro-thumbnail">
                                                            <a href="/product-details?_id=<%= product.productId._id %>">
                                                                <img src="/images/product/original/<%= product.image %>" alt="Product" style="width: 50px; height: 60px;">
                                                            </a>
                                                        </td>
                                                        <td class="pro-title">
                                                            <a href="/product-details?_id=<%= product.productId %>">
                                                                <%= product.productName %>
                                                            </a>
                                                        </td>
                                                        <td class="pro-price"><span><%= product.price %></span></td>
                                                        <td class="pro-quantity">
                                                            <input type="number" id="quantity-input" data-product-id="<%= product.productId._id %>" value="<%= product.count %>">
                                                        </td>
                                                        <td class="pro-total"><span><%= product.totalPrice %></span></td>
                                                        <td>
                                                            <button type="button" onclick="removeItem('<%= product.productId._id %>')">
                                                                <i class="fa fa-trash-o"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                <% } %> <!-- End of safeguard -->
                                            <% }) %>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="6">No products available</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </form>

                    <div class="row">
                        <div class="col-lg-6 col-12 mb--15">
                            <!-- Calculate Shipping -->
                            <div class="calculate-shipping">
                                <h4>Calculate Shipping</h4>
                                <form action="#">
                                    <div class="row">
                                        <div class="col-md-6 col-12 mb--25">
                                            <select class="nice-select">
                                                <option>Bangladesh</option>
                                                <option>China</option>
                                                <option>country</option>
                                                <option>India</option>
                                                <option>Japan</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 col-12 mb--25">
                                            <select class="nice-select">
                                                <option>Dhaka</option>
                                                <option>Barisal</option>
                                                <option>Khulna</option>
                                                <option>Comilla</option>
                                                <option>Chittagong</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 col-12 mb--25">
                                            <input type="text"
                                                placeholder="Postcode / Zip">
                                        </div>
                                        <div class="col-md-6 col-12 mb--25">
                                            <input type="submit"
                                                value="Estimate">
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <!-- Discount Coupon -->
                            <div class="discount-coupon">
                                <h4>Discount Coupon Code</h4>
                                <form action="#">
                                    <div class="row">
                                        <div class="col-md-6 col-12 mb--25">
                                            <input type="text"
                                                placeholder="Coupon Code">
                                        </div>
                                        <div class="col-md-6 col-12 mb--25">
                                            <input type="submit"
                                                value="Apply Code">
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Cart Summary -->
                        <div class="col-lg-6 col-12 mb--40 d-flex">
                            <div class="cart-summary">
                                <div class="cart-summary-wrap">
                                    <h4>Cart Summary</h4>
                                    <p>Sub Total <span>$<%= subTotal
                                            %>.00</span></p>
                                    <p>Shipping Cost <span>$<%= shippingCharge
                                            %>.00</span></p>
                                    <h2>Grand Total <span>$<%= grandTotal
                                            %>.00</span></h2>
                                </div>
                                <div class="cart-summary-button">
                                    <button class="checkout-btn"><a
                                            href="/checkout">Checkout</a></button>
                                    <button class="update-btn"
                                        id="updateCartButton">Update
                                        Cart</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Cart Page End -->
</div>

<!-- Quick View Modal -->
<div class="quick-view-modal">
    <div class="quick-view-modal-inner">
        <div class="container">
            <div class="product-details">
                <!-- Product Details Left -->
                <div class="product-details-left">
                    <div class="product-details-images slider-navigation-2">
                        <a href="#">
                            <img class="w-100"
                                src="assets/images/product/product-01.jpg"
                                alt="product image">
                        </a>
                        <a href="#">
                            <img class="w-100"
                                src="assets/images/product/product-02.jpg"
                                alt="product image">
                        </a>
                        <a href="#">
                            <img class="w-100"
                                src="assets/images/product/product-03.jpg"
                                alt="product image">
                        </a>
                        <a href="#">
                            <img class="w-100"
                                src="assets/images/product/product-04.jpg"
                                alt="product image">
                        </a>
                        <a href="#">
                            <img class="w-100"
                                src="assets/images/product/product-05.jpg"
                                alt="product image">
                        </a>
                    </div>
                    <div class="product-details-thumbs slider-navigation-2">
                        <img src="assets/images/product/product-01.jpg"
                            alt="product image thumb">
                        <img src="assets/images/product/product-02.jpg"
                            alt="product image thumb">
                        <img src="assets/images/product/product-03.jpg"
                            alt="product image thumb">
                        <img src="assets/images/product/product-04.jpg"
                            alt="product image thumb">
                        <img src="assets/images/product/product-05.jpg"
                            alt="product image thumb">
                    </div>
                </div>
                <!--// Product Details Left -->

                <!-- Product Details Right -->
                <div class="product-details-right">
                    <h5 class="product-title">Demo Product Name</h5>

                    <div class="ratting-stock-availbility">
                        <div class="ratting-box">
                            <span><i class="fa fa-star"></i></span>
                            <span><i class="fa fa-star"></i></span>
                            <span><i class="fa fa-star"></i></span>
                            <span><i class="fa fa-star"></i></span>
                            <span><i class="fa fa-star"></i></span>
                        </div>
                        <span class="stock-available">In stock</span>
                    </div>

                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                        Nam fringilla augue nec est
                        tristique auctor. Donec non est at libero vulputate
                        rutrum. Morbi ornare lectus quis
                        justo gravida semper. Nulla tellus mi, vulputate
                        adipiscing cursus eu, suscipit id
                        nulla. adipiscing cursus eu, suscipit id nulla.</p>

                    <div class="price-box">
                        <span class="pricebox-price">£80.00</span>
                    </div>

                    <div class="product-details-quantity">
                        <div class="quantity-select">
                            <div class="pro-quantity">
                                <div class="pro-qty"><input type="text"
                                        value="1"></div>
                            </div>
                        </div>
                        <a href="#" class="add-to-cart-button">
                            <span>ADD TO CART</span>
                        </a>
                    </div>

                    <div class="product-details-color">
                        <span>Color :</span>
                        <ul>
                            <li class="red"><span></span></li>
                            <li class="green checked"><span></span></li>
                            <li class="blue"><span></span></li>
                            <li class="black"><span></span></li>
                        </ul>
                    </div>

                    <div class="product-details-size">
                        <span>Size :</span>
                        <ul>
                            <li class="checked"><span>S</span></li>
                            <li><span>M</span></li>
                            <li><span>L</span></li>
                            <li><span>XL</span></li>
                            <li><span>XXL</span></li>
                        </ul>
                    </div>

                    <div class="product-details-categories">
                        <span>Categories :</span>
                        <ul>
                            <li><a href="shop.html">Accessories</a></li>
                            <li><a href="shop.html">Kids</a></li>
                            <li><a href="shop.html">Women</a></li>
                        </ul>
                    </div>

                    <div class="product-details-tags">
                        <span>Tags :</span>
                        <ul>
                            <li><a href="shop.html">Electronic</a></li>
                            <li><a href="shop.html">Television</a></li>
                        </ul>
                    </div>

                    <div class="product-details-socialshare">
                        <span>Share :</span>
                        <ul>
                            <li><a class="facebook" href="#"><i
                                        class="fa fa-facebook"></i></a></li>
                            <li><a class="twitter" href="#"><i
                                        class="fa fa-twitter"></i></a></li>
                            <li><a class="google-plus" href="#"><i
                                        class="fa fa-google-plus"></i></a></li>
                            <li><a class="linkedin" href="#"><i
                                        class="fa fa-linkedin"></i></a></li>
                            <li><a class="instagram" href="#"><i
                                        class="fa fa-instagram"></i></a></li>
                        </ul>
                    </div>
                </div>
                <!--// Product Details Right -->

            </div>
        </div>
    </div>
    <button class="close-quickview-modal"><i class="fa fa-close"></i></button>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
     function removeItem(product_Id) {
                Swal
                    .fire({
                        title: "Are You Sure?",
                        text: " You wont be able to revert this!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#3085d6",
                        cancelButtonColor: "#d33",
                        confirmButtonText: "Yes, delete it!",
                        cancelButtonText: "cancel",
                    })
                    .then((result) => {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: "/removeCartItem",
                                data: {
                                    product: product_Id,
                                },
                                method: "post",
                                success: (response) => {
                                    if ((response.success)) {
                                     
                                        Swal.fire({
                                            title: "Deleted!",
                                            text: "Your item has been deleted.",
                                            icon: "success",
                                            timer: 1500,
                                            showConfirmButton: false,
                                        }).then(() => {
                                            location.reload();
                                        });
                                    }
                                },
                            });
                        }
                    });
            }

           
document.getElementById('updateCartButton').addEventListener('click', async function() {
    const count = [];
    document.querySelectorAll('#quantity-input').forEach(input => {
        const productId = input.dataset.productId;
        console.log(productId)
        const newQuantity = parseInt(input.value);
        count.push({ productId, newQuantity });
    });

    try {
        const response = await fetch('/update-cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(count),
        });
        const data = await response.json();
        if (data.stock) {
            Swal.fire({
                icon: 'warning',
                title: 'updating',
                text: "out of stock ,will update soon",
            });
        }else if(data.success){
            Swal.fire({
                icon: 'success',
                title: 'done',
                text: "cart update successfully",
            }) 
            .then(() => {
                window.location.href="/cart"
            })
        }
         else {
            console.log(data);
       
        }
    } catch (error) {
        console.error('Error updating cart:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'An error occurred while updating the cart.',
        });
    }
});
        

    </script>

<%- include("../layouts/user/footer.ejs") %>